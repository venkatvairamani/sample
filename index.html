This is the code edited from test branch.